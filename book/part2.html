<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Part 2 - testy bootowania - kurs pisania podstawowego systemu w języku C</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><li class="part-title">Edycja C</li><li class="chapter-item expanded "><a href="part1.html"><strong aria-hidden="true">1.</strong> Part 1 - minimalny kernel</a></li><li class="chapter-item expanded "><a href="part2.html" class="active"><strong aria-hidden="true">2.</strong> Part 2 - testy bootowania</a></li><li class="chapter-item expanded "><a href="part3.html"><strong aria-hidden="true">3.</strong> Part 3 - Paging, zarządzanie pamięcią</a></li><li class="chapter-item expanded "><a href="part4.html"><strong aria-hidden="true">4.</strong> Part 4 - </a></li><li class="chapter-item expanded "><a href="part5.html"><strong aria-hidden="true">5.</strong> Part 5 - </a></li><li class="chapter-item expanded "><a href="part6.html"><strong aria-hidden="true">6.</strong> Part 6 - </a></li><li class="chapter-item expanded affix "><li class="part-title">Edycja RUST (TODO!)</li><li class="chapter-item expanded affix "><li class="part-title">Edycja GO (TODO!)</li><li class="chapter-item expanded affix "><li class="part-title">Edycja C++ (NEVER!)</li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">kurs pisania podstawowego systemu w języku C</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="testy-poprawnego-bootowania---part-2"><a class="header" href="#testy-poprawnego-bootowania---part-2">Testy poprawnego bootowania - Part 2</a></h1>
<h2 id="wprowadzenie"><a class="header" href="#wprowadzenie">Wprowadzenie</a></h2>
<p>Jesteśmy już w trybie protected oraz posiadamy kontrolę nad tym co robi procesor. Mogli byśmy już przechodzić do trybu 64 bitowego, ale procesory mają to do siebie że mają różne specyfikacje, funkcjonalności, oraz zestawy instrukcji.</p>
<p>Z tego powodu musimy napisać odpowiednie testy które pozwolą na poprawne przejście do trybu 64 bit a w przeciwnym razie HALT procesora.</p>
<h2 id="struktura-projektu"><a class="header" href="#struktura-projektu">Struktura projektu</a></h2>
<p>Struktura projektu pozostaje bez zmian względem poprzedniej części. W następnej przeniesiemy check-i do oddzilenych plików</p>
<h2 id="inicjacja-stosu"><a class="header" href="#inicjacja-stosu">Inicjacja stosu</a></h2>
<p>Do wykonania niektórych testów będziemy potrzebować stosu, niestety nie mamy pod nami systemu który może nam przydzielić pamięć a więc musimy sami zdecydować ile jej potrzebujemy i zadeklarować tą ilość w sekcji <code>.bss</code></p>
<blockquote>
<p>plik: src/boot.asm</p>
</blockquote>
<pre><code class="language-x86asm">section .bss
stack_bottom:
    resb 64
stack_top:
</code></pre>
<p>Tagi <code>stack_bottom</code> i <code>stack_top</code> ułatwiają nam znalezienie granic stosu, na ten moment rezerwujemy tylko 64 bajty, potem będziemy modyfikować tą wartośc.</p>
<p>Teraz musimy zainicjować <code>ESP</code> aby móc używać instrukcji służących do wypychania i ściągania danych ze stacku.</p>
<blockquote>
<p>plik: src/boot.asm</p>
</blockquote>
<pre><code class="language-x86asm">...

start:
    ; w procesorach potomnych dla i386 stack zaczyna się od jego góry i kończy na spodzie
    mov  esp, stack_top
    
...
</code></pre>
<h2 id="test-multiboot"><a class="header" href="#test-multiboot">Test Multiboot</a></h2>
<p>Test ten jest odpowiedzialny za sprawdzenie czy system został odpalony z użyciem multiboot (grub), jest to ważne ponieważ potem można wykorzystywać informację o tym do pozyskania dodatkowych informacji o dostępnym sprzęcie.</p>
<p>Z dokumentacji możemy się dowiedzieć że multiboot na zakończenie swojej pracy ładuje do rejestru <code>EAX</code> wartość <code>0x36d76289</code>, jeśli jest tam inna wartość to nastąpił jakiegoś rodzaju błąd lub nie kernel nie został uruchomiony z użyciem multiboot</p>
<blockquote>
<p>plik: src/boot.asm</p>
</blockquote>
<pre><code class="language-x86asm">multiboot_check:
    cmp eax, 0x36d76289
    
    ; jeśli EAX nie jest równe powyższej wartości to przechodzimy do błędu procesora
    jne .multiboot_error
    ret
 
    ; jeśli procedura nie zadziała poprawnie musimy zgłosić błąd
.multiboot_error:
    mov  al, "M"
    call error
</code></pre>
<h2 id="test-cpuid"><a class="header" href="#test-cpuid">Test CPUID</a></h2>
<p>Sprawdzenie obecności CPUID wykonuje się poprzed obrót bitu 21 w rejestrze FLAGS.
Jeżeli uda nam się poprawnie obrócić bit, wpisać wartość do rejestru FLAGS i pobrać ją ponownie i w trakcie tej operacji bit 21 wróci do swojego początkowego stanu to zestaw instrukcji CPUID jest dostępny.</p>
<blockquote>
<p>plik: src/boot.asm</p>
</blockquote>
<pre><code class="language-x86asm">cpuid_check:
    ; skopiowane FLAGS do EAX używając stack-u
    ; pushfd wypycha FLAGS na stack
    pushfd
    pop eax

    ; kopiowanie FLAGS z EAX do ECX
    mov ecx, eax

    ; obrócenie bitu 21
    xor eax, 1 &lt;&lt; 21

    ; ustawienie rejestru FLAGS na wartość z EAX z obróconym bitem 21
    push eax
    popfd

    ; ponowne skopiowanie FLAGS do EAX, jeśli bit się obrócił z powrotem to posiadamy CPUID
    pushfd
    pop eax

    ; przywrócenie początkowej wersji rejestru FLAGS
    push ecx
    popfd

    ; jeżeli EAX i ECX są równe to znaczy że bit 21 nie został obrucony co znaczy że nie posiadamy CPUID
    cmp eax, ecx
    je  .cpuid_error
    ret
.cpuid_error:
    mov al, "C"
    jmp error

</code></pre>
<h2 id="test-longmode"><a class="header" href="#test-longmode">Test Longmode</a></h2>
<p>Ostatnim krokiem dla nas jest sprawdzenie czy dostępny jest tryb 64 bitowy. Wywołująć instrukcję <code>cpuid</code> z argumentem <code>0x80000000</code> spowoduje sprawdzenie maksymalnej dostępnej wersji CPUID w naszym procesorze, dla naszych potrzeb wystarczy wersja <code>0x80000001</code>.</p>
<p>Instrukcja <code>Cpuid</code> z argumentem <code>0x80000001</code> ładuje do głównych 4 rejesetrów dużo informacji na temat procesora, w tym informacje o dostępnych trybach działania oraz posiadanych zestawach instrukcji. Po wywołaniu tej instrukcji w rejestrze <code>EDX</code> na bicie 29 znajduje się informacja czy longmode jest dostępny.</p>
<blockquote>
<p>plik: src/boot.asm</p>
</blockquote>
<pre><code class="language-x86asm">long_mode_check:
    ; sprawdzenie czy rozszerzone informacje o pocesorze są dostępne
    mov eax, 0x80000000
    cpuid                  
    ; minimalna wersja z longmode to 0x80000001, jeśli jest mniej to wywołujemy błąd
    cmp eax, 0x80000001
    jb  .long_mode_error

    ; sprawdzenie czy longmode jest dostępny
    ; argument dla CPUID do uzyskania rozszezrzonych informacji 
    mov eax, 0x80000001
    cpuid

    ; sprawdznie czy LM-bit jest ustawiony w EDX, jeśli nie to wywołujemy błąd
    test edx, 1 &lt;&lt; 29
    jz   .long_mode_error
    ret
.long_mode_error:
    mov al, "L"
    jmp error
</code></pre>
<h2 id="wykorzystanie-testów"><a class="header" href="#wykorzystanie-testów">Wykorzystanie testów</a></h2>
<p>Testy już są napisane teraz trzeba je wywołać w odpowiedniej kolejności.</p>
<ol>
<li>Multiboot</li>
<li>CPUID</li>
<li>Longmode</li>
</ol>
<p>A więc po ich dodaniu w <code>start</code> będzie wyglądał następująco:</p>
<blockquote>
<p>plik: src/boot.asm</p>
</blockquote>
<pre><code class="language-x86asm">...

start:
    ; w procesorach potomnych dla i386 stack zaczyna się od jego góry i kończy na spodzie
    mov  esp, stack_top

    ; wywołanie procedury sprawdzenia multiboot
    call multiboot_check
    
    ; wywołanie procedury sprawdzenia CPUID
    call cpuid_check

    ; wywołanie prrocedury sprawdzenia longmode
    call long_mode_check

...
</code></pre>
<h2 id="uruchomienie"><a class="header" href="#uruchomienie">Uruchomienie</a></h2>
<p>Jeżeli wszystko zadziałało poprawnie, po wykonaniu komendy <code>make run</code> powinniśmy zobaczyć taki obraz w maszynie:</p>
<p><img src="./photos/part2_working.png" alt="image" /></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="part1.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="part3.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="part1.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="part3.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
